name: Build JDCloud2.0-IPQ4019 (P&W R619AC-128m) OpenWrt

# 仅手动触发编译（避免自动消耗额度）
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      # 1. 拉取仓库代码
      - name: Checkout
        uses: actions/checkout@main

      # 2. 安装IPQ4019编译依赖
      - name: Initialization environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt update -y
          sudo apt full-upgrade -y
          # 基础依赖
          sudo apt install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf python2.7 python3 python3-pip libpython3-dev qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev
          # IPQ4019额外依赖（NAND闪存+高通无线）
          sudo apt install -y mtd-utils nand-utils libssl-dev libnl-3-dev libnl-genl-3-dev

      # 3. 下载Lean's LEDE源码（已适配R619AC-128m）
      - name: Download source code
        run: |
          git clone --depth=1 https://github.com/coolsnowwolf/lede openwrt
          cd openwrt
          # 更新软件包源
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 4. 配置R619AC-128m编译参数（核心！精准适配）
      - name: Configure P&W R619AC-128m firmware
        run: |
          cd openwrt
          # 加载ipq40xx/generic基础配置
          make defconfig TARGET=ipq40xx SUBTARGET=generic
          # 指定设备型号（128MB NAND版本）
          echo "CONFIG_TARGET_DEVICE_ipq40xx_generic_DEVICE_p2w_r619ac-128m=y" >> .config
          # 启用无线固件（QCA9886+QCA9887，必须添加）
          echo "CONFIG_PACKAGE_ipq-wifi-p2w_r619ac=y" >> .config
          # 启用无线驱动
          echo "CONFIG_PACKAGE_kmod-ath10k=y" >> .config
          echo "CONFIG_PACKAGE_kmod-ath10k-ct=y" >> .config
          echo "CONFIG_PACKAGE_ath10k-firmware-qca9886=y" >> .config
          echo "CONFIG_PACKAGE_ath10k-firmware-qca9887=y" >> .config
          # 常用功能包（可按需增删）
          echo "CONFIG_PACKAGE_luci-app-passwall=y" >> .config       # 科学上网
          echo "CONFIG_PACKAGE_luci-app-ddns=y" >> .config          # DDNS
          echo "CONFIG_PACKAGE_luci-app-samba4=y" >> .config        # 网络共享
          echo "CONFIG_PACKAGE_luci-app-adguardhome=y" >> .config   # 去广告
          echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config       # 美化主题
          echo "CONFIG_PACKAGE_luci-app-openclash=y" >> .config     #  clash代理
          # 优化编译选项（IPQ4019性能提升）
          echo "CONFIG_CPU_TYPE=\"cortex-a7\"" >> .config
          echo "CONFIG_EXTRA_OPTIMIZATION=\"-O2 -pipe -mtune=cortex-a7\"" >> .config
          # 生成最终配置
          make defconfig

      # 5. 编译固件（自动处理NAND分区）
      - name: Build firmware
        run: |
          cd openwrt
          # 下载依赖包（解决IPQ40xx无线固件下载问题）
          make -j$(nproc) download V=s
          # 删除损坏的依赖包
          find dl -size -1024c -exec rm -f {} \;
          # 编译（失败时单线程重试，确保兼容性）
          make -j$(nproc) V=s || make -j1 V=s

      # 6. 上传固件到GitHub Artifacts
      - name: Upload firmware
        uses: actions/upload-artifact@main
        with:
          name: R619AC-128m-OpenWrt-Firmware
          path: openwrt/bin/targets/ipq40xx/generic/
